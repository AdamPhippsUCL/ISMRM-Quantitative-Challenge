%% Image settings

% Define TE
TE = 125

% b val

%% Histogram

% Remove anomalies from ROIvals
upperprctle = prctile(ROIvals, 75);
lowerprcntle = prctile(ROIvals, 25);
med = median(ROIvals);
IQR = upperprctle-lowerprcntle;

ROIvals = ROIvals(ROIvals<med+2*IQR);
ROIvals = ROIvals(ROIvals>med-2*IQR);

% Define bins
binmin = 0;
binmax = 2;
nbin = 1000;

binedges = linspace(binmin, binmax, nbin+1);
bincenters = (binedges(:,1:end-1) + binedges(:,2:end)) / 2 ;

f = figure;%('visible','off');
H = histogram(ROIvals, binedges);
hold on;
counts = H.Values;


%% Fitting

fdguess = mean(ROIvals);
T2guess = 400;
sigma0guess = 0.01;

beta0guess = [sigma0guess, T2guess, fdguess];

[coeffs, resnorm] = fitDistToHist(counts, bincenters, beta0guess = beta0guess, TE = TE, disttype = 'Ratio');

fd = coeffs(3);
ADC = -log(fd)/b;